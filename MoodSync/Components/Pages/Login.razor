@page "/login"
@using Microsoft.EntityFrameworkCore
@using MoodSync.Components.Layout
@using MoodSync.Data
@using MoodSync.Models
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ApplicationDbContext DbContext
@inject LoginStateService LoginStateService
@layout MainLayout

@code {
    private User loginUser = new User();
    private string errorMessage;

    private async Task LoginUser()
    {
        var existingUser = await DbContext.Users
            .FirstOrDefaultAsync(u => u.UserName == loginUser.UserName);

        if (existingUser == null)
        {
            errorMessage = "Invalid username or password!";
            return;
        }

        LoginStateService.Login();
        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "isLoggedIn", "true");
        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "username", loginUser.UserName);

        NavigationManager.NavigateTo("/dashboard");
    }
}

<div class="login-form">
    <h2>Login</h2>
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-message">@errorMessage</div>
    }

    <input @bind="loginUser.UserName" placeholder="Username" />
    <input @bind="loginUser.Password" type="password" placeholder="Password" />
    <button @onclick="LoginUser">Login</button>

    <p>Don't have an account? <a href="/register">Register here</a></p>
</div> 
